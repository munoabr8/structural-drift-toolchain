name: ROI Aggregator (Artifacts Only)

on:
  schedule: [{ cron: "37 02 * * *" }]  # UTC
  workflow_dispatch:
 
  push:
    paths:
      - ".github/workflows/roi-aggregator.yml"
      - "./ci/roi/**"
  workflow_run:
    workflows: ["Workflow Stats","PR First Pass","CI Hours","ROI Baseline"]
    types: [completed]
  
permissions:
  contents: read
  actions: read

concurrency:
  group: roi-aggregator
  cancel-in-progress: true

jobs:
  roi:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      WINDOW_DAYS: "14"
      GH_TOKEN: ${{ github.token }}

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq gh unzip

      - name: Fetch required artifacts
        env:
          REPO: ${{ github.repository }}
        run: bash ./ci/roi/fetch_artifacts.sh

      - name: Build inputs from artifacts
        id: inputs
        run: bash ./ci/roi/build_inputs.sh

      - name: Compute ROIT
        run: python3 ./ci/roi/compute_roit.py | tee -a "$GITHUB_STEP_SUMMARY"
        env:
          WINDOW_DAYS: ${{ env.WINDOW_DAYS }}
          RUNS:  ${{ steps.inputs.outputs.runs }}
          TA:    ${{ steps.inputs.outputs.avg_sec }}
          PRS:   ${{ steps.inputs.outputs.total }}
          PA:    ${{ steps.inputs.outputs.pa }}
          TB:    ${{ steps.inputs.outputs.tb }}
          PB:    ${{ steps.inputs.outputs.pb }}
          R:     ${{ steps.inputs.outputs.r }}
          H:     ${{ steps.inputs.outputs.hours }}
