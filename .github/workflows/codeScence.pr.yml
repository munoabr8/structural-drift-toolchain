# .github/workflows/codescene-pr.yml
name: codescene-pr
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  codescene:
    if: ${{ !github.event.pull_request.head.repo.fork }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      TOOL_TAG: v1.3.3
      CODESCENE_DELTA_ANALYSIS_URL: ${{ secrets.CODESCENE_DELTA_ANALYSIS_URL }}
      CODESCENE_USER:               ${{ secrets.CODESCENE_USER }}
      CODESCENE_PASSWORD:           ${{ secrets.CODESCENE_PASSWORD }}
      GITHUB_API_TOKEN:             ${{ secrets.CODESCENE_GH_PAT }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Lein/Maven deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.lein
          key: ${{ runner.os }}-lein-m2-${{ env.TOOL_TAG }}

      - name: Restore CodeScene jar
        id: jar-cache
        uses: actions/cache@v4
        with:
          path: .cache/codescene-ci-cd.jar
          key: ${{ runner.os }}-codescene-ci-cd-${{ env.TOOL_TAG }}

      - name: Install Leiningen (on PATH)
        if: ${{ steps.jar-cache.outputs.cache-hit != 'true' }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME/bin"
          curl -fsSL https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein -o "$HOME/bin/lein"
          chmod +x "$HOME/bin/lein"
          echo "$HOME/bin" >> "$GITHUB_PATH"
          lein -v

      - name: Configure repos and build CodeScene CI/CD jar
        if: ${{ steps.jar-cache.outputs.cache-hit != 'true' }}
        run: |
          set -euo pipefail
          mkdir -p ~/.lein
          cat > ~/.lein/profiles.clj <<'EOF'
          {:user
           :repositories
             [["central" {:url "https://repo1.maven.org/maven2/"}]
              ["clojars" {:url "https://repo.clojars.org/"}]]
           :plugin-repositories
             [["central" {:url "https://repo1.maven.org/maven2/"}]
              ["clojars" {:url "https://repo.clojars.org/"}]]}
          EOF

          curl -fsSL https://repo.clojars.org/slingshot/slingshot/0.12.2/slingshot-0.12.2.jar -o /dev/null

          mkdir -p .cache
          git clone --depth 1 --branch "$TOOL_TAG" https://github.com/empear-analytics/codescene-ci-cd.git .cache/codescene-ci-cd
          cd .cache/codescene-ci-cd
          git config --global advice.detachedHead false
          lein -U deps
          lein -U uberjar
          ls -l target/uberjar/
          cp target/uberjar/codescene-ci-cd-*-standalone.jar ../codescene-ci-cd.jar
          java -jar ../codescene-ci-cd.jar --help >/dev/null

      - name: Run CodeScene delta analysis and comment
        run: |
          java -jar .cache/codescene-ci-cd.jar \
            --codescene-delta-analysis-url "${CODESCENE_DELTA_ANALYSIS_URL}" \
            --codescene-user "${CODESCENE_USER}" \
            --codescene-password "${CODESCENE_PASSWORD}" \
            --analyze-branch-diff \
            --create-github-comment \
            --github-api-url "https://api.github.com" \
            --github-api-token "${GITHUB_API_TOKEN}" \
            --github-owner "${{ github.repository_owner }}" \
            --github-repo  "${{ github.event.repository.name }}" \
            --github-pull-request-id "${{ github.event.pull_request.number }}" \
            --coupling-threshold-percent 75 \
            --fail-on-high-risk \
            --result-path result.json \
            --log-result

      - name: Upload result.json
        if: ${{ always() && hashFiles('result.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: codescene-result
          path: result.json
