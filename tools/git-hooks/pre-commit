#!/bin/bash
# tools/git-hooks/pre-commit
#
# This hook runs before each commit to ensure the repository
# structure is valid and that basic checks pass.  If any check fails,
# the commit is aborted.

# Resolve the repository root (two levels up from .git/hooks)
REPO_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
cd "$REPO_ROOT"

echo "ğŸ” Running pre-commit structural checks..."

# Preflight checks (similar to the pre-push hook)
make preflight || {
  echo "âŒ Preflight checks failed â€” commit aborted."
  exit 1
}

# Detect structural drift
make check-structure-drift || {
  echo "âŒ Drift detected â€” commit aborted."
  exit 1
}

# Ensure the current structure conforms to the specification
make enforce-structure || {
  echo "âŒ Structure invalid â€” commit aborted."
  exit 1
}

# Optionally run a minimal test suite (fast checks only)
make test-structure || {
  echo "âŒ Structure tests failed â€” commit aborted."
  exit 1
}

echo "âœ… All pre-commit checks passed. Commit allowed."
