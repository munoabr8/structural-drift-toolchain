#!/bin/bash
# tools/git-hooks/pre-commit
#
# This hook runs before each commit to ensure the repository
# structure is valid and that basic checks pass.  If any check fails,
# the commit is aborted.

# Resolve the repository root (two levels up from .git/hooks)
REPO_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"
cd "$REPO_ROOT"

echo "🔍 Running pre-commit structural checks..."

# Preflight checks (similar to the pre-push hook)
make preflight || {
  echo "❌ Preflight checks failed — commit aborted."
  exit 1
}

# Detect structural drift
make check-structure-drift || {
  echo "❌ Drift detected — commit aborted."
  exit 1
}

# Ensure the current structure conforms to the specification
make enforce-structure || {
  echo "❌ Structure invalid — commit aborted."
  exit 1
}

# Optionally run a minimal test suite (fast checks only)
make test-structure || {
  echo "❌ Structure tests failed — commit aborted."
  exit 1
}

echo "✅ All pre-commit checks passed. Commit allowed."
